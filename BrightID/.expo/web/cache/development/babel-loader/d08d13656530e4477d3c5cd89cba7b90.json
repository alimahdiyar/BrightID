{"ast":null,"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.uploadDeviceInfo = exports.uploadAllInfoAfter = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _store = require(\"../../../../store\");\n\nvar _encoding = require(\"../../../../utils/encoding\");\n\nvar _cryptoHelper = require(\"../../../../utils/cryptoHelper\");\n\nvar _filesystem = require(\"../../../../utils/filesystem\");\n\nvar _connectionsSlice = require(\"../../../../reducer/connectionsSlice\");\n\nvar _appsSlice = require(\"../../../../reducer/appsSlice\");\n\nvar _channelService = _interopRequireDefault(require(\"../../../../api/channelService\"));\n\nvar _channels = require(\"../../../../utils/channels\");\n\nvar _constants = require(\"../../../../utils/constants\");\n\nfunction _createForOfIteratorHelperLoose(o, allowArrayLike) { var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"]; if (it) return (it = it.call(o)).next.bind(it); if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") { if (it) o = it; var i = 0; return function () { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }; } throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\"); }\n\nfunction _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === \"string\") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === \"Object\" && o.constructor) n = o.constructor.name; if (n === \"Map\" || n === \"Set\") return Array.from(o); if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }\n\nfunction _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }\n\nvar uploadAllInfoAfter = function _callee(after) {\n  var _store$getState, user, signingKey, groups, _store$getState$recov, _store$getState$recov2, url, channelId, aesKey, isPrimaryDevice, channelApi, photo, data, encrypted, userDataId, connections, _iterator, _step, conn, _iterator2, _step2, group, linkedContexts, _iterator3, _step3, contextInfo, sigs, _iterator4, _step4, sig, completeDataId;\n\n  return _regenerator.default.async(function _callee$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          _store$getState = _store.store.getState(), user = _store$getState.user, signingKey = _store$getState.keypair.publicKey, groups = _store$getState.groups.groups, _store$getState$recov = _store$getState.recoveryData, _store$getState$recov2 = _store$getState$recov.channel, url = _store$getState$recov2.url, channelId = _store$getState$recov2.channelId, aesKey = _store$getState$recov.aesKey, isPrimaryDevice = _store$getState.settings.isPrimaryDevice;\n          channelApi = new _channelService.default(url.href);\n          console.log('uploading user info');\n          _context.next = 5;\n          return _regenerator.default.awrap((0, _filesystem.retrieveImage)(user.photo.filename));\n\n        case 5:\n          photo = _context.sent;\n          data = {\n            id: user.id,\n            name: user.name,\n            photo: photo,\n            isSponsored: user.isSponsored,\n            isSponsoredv6: user.isSponsoredv6,\n            backupCompleted: user.backupCompleted,\n            password: user.password,\n            updateTimestamps: user.updateTimestamps\n          };\n          encrypted = (0, _cryptoHelper.encryptData)(data, aesKey);\n          userDataId = _constants.IMPORT_PREFIX + \"userinfo_\" + user.id + \":\" + (0, _encoding.b64ToUrlSafeB64)(signingKey);\n          _context.next = 11;\n          return _regenerator.default.awrap(channelApi.upload({\n            channelId: channelId,\n            dataId: userDataId,\n            data: encrypted\n          }));\n\n        case 11:\n          console.log('uploading connections');\n          connections = (0, _connectionsSlice.selectAllConnections)(_store.store.getState()).filter(function (conn) {\n            return conn.timestamp > after;\n          });\n          _iterator = _createForOfIteratorHelperLoose(connections);\n\n        case 14:\n          if ((_step = _iterator()).done) {\n            _context.next = 20;\n            break;\n          }\n\n          conn = _step.value;\n          _context.next = 18;\n          return _regenerator.default.awrap((0, _channels.uploadConnection)({\n            conn: conn,\n            channelApi: channelApi,\n            aesKey: aesKey,\n            signingKey: signingKey\n          }));\n\n        case 18:\n          _context.next = 14;\n          break;\n\n        case 20:\n          console.log('uploading groups');\n          _iterator2 = _createForOfIteratorHelperLoose(groups);\n\n        case 22:\n          if ((_step2 = _iterator2()).done) {\n            _context.next = 29;\n            break;\n          }\n\n          group = _step2.value;\n\n          if (!(group.joined > after)) {\n            _context.next = 27;\n            break;\n          }\n\n          _context.next = 27;\n          return _regenerator.default.awrap((0, _channels.uploadGroup)({\n            group: group,\n            channelApi: channelApi,\n            aesKey: aesKey,\n            signingKey: signingKey\n          }));\n\n        case 27:\n          _context.next = 22;\n          break;\n\n        case 29:\n          console.log('uploading linked contexts');\n          linkedContexts = (0, _appsSlice.selectAllLinkedContexts)(_store.store.getState()).filter(function (linkedContext) {\n            return linkedContext.dateAdded > after && linkedContext.state === 'applied';\n          });\n          _iterator3 = _createForOfIteratorHelperLoose(linkedContexts);\n\n        case 32:\n          if ((_step3 = _iterator3()).done) {\n            _context.next = 38;\n            break;\n          }\n\n          contextInfo = _step3.value;\n          _context.next = 36;\n          return _regenerator.default.awrap((0, _channels.uploadContextInfo)({\n            contextInfo: contextInfo,\n            channelApi: channelApi,\n            aesKey: aesKey,\n            signingKey: signingKey,\n            prefix: _constants.IMPORT_PREFIX\n          }));\n\n        case 36:\n          _context.next = 32;\n          break;\n\n        case 38:\n          console.log('uploading blind sigs');\n\n          if (!isPrimaryDevice) {\n            _context.next = 49;\n            break;\n          }\n\n          sigs = (0, _appsSlice.selectAllSigs)(_store.store.getState());\n          _iterator4 = _createForOfIteratorHelperLoose(sigs);\n\n        case 42:\n          if ((_step4 = _iterator4()).done) {\n            _context.next = 49;\n            break;\n          }\n\n          sig = _step4.value;\n\n          if (!(sig.signedTimestamp > after || sig.linkedTimestamp > after)) {\n            _context.next = 47;\n            break;\n          }\n\n          _context.next = 47;\n          return _regenerator.default.awrap((0, _channels.uploadBlindSig)({\n            sig: sig,\n            channelApi: channelApi,\n            aesKey: aesKey,\n            signingKey: signingKey,\n            prefix: _constants.IMPORT_PREFIX\n          }));\n\n        case 47:\n          _context.next = 42;\n          break;\n\n        case 49:\n          console.log('uploading completed flag');\n          completeDataId = _constants.IMPORT_PREFIX + \"completed_\" + user.id + \":\" + (0, _encoding.b64ToUrlSafeB64)(signingKey);\n          _context.next = 53;\n          return _regenerator.default.awrap(channelApi.upload({\n            channelId: channelId,\n            dataId: completeDataId,\n            data: 'completed'\n          }));\n\n        case 53:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, null, null, null, Promise);\n};\n\nexports.uploadAllInfoAfter = uploadAllInfoAfter;\n\nvar uploadDeviceInfo = function _callee2() {\n  var _store$getState2, _store$getState2$reco, _store$getState2$reco2, url, channelId, signingKey, _store$getState2$sett, lastSyncTime, isPrimaryDevice, dataObj, data, channelApi;\n\n  return _regenerator.default.async(function _callee2$(_context2) {\n    while (1) {\n      switch (_context2.prev = _context2.next) {\n        case 0:\n          _store$getState2 = _store.store.getState(), _store$getState2$reco = _store$getState2.recoveryData, _store$getState2$reco2 = _store$getState2$reco.channel, url = _store$getState2$reco2.url, channelId = _store$getState2$reco2.channelId, signingKey = _store$getState2$reco.publicKey, _store$getState2$sett = _store$getState2.settings, lastSyncTime = _store$getState2$sett.lastSyncTime, isPrimaryDevice = _store$getState2$sett.isPrimaryDevice;\n          dataObj = {\n            signingKey: signingKey,\n            lastSyncTime: lastSyncTime,\n            isPrimaryDevice: isPrimaryDevice\n          };\n          data = JSON.stringify(dataObj);\n          channelApi = new _channelService.default(url.href);\n          _context2.next = 6;\n          return _regenerator.default.awrap(channelApi.upload({\n            channelId: channelId,\n            data: data,\n            dataId: _constants.IMPORT_PREFIX + \"data\",\n            requestedTtl: _constants.RECOVERY_CHANNEL_TTL\n          }));\n\n        case 6:\n        case \"end\":\n          return _context2.stop();\n      }\n    }\n  }, null, null, null, Promise);\n};\n\nexports.uploadDeviceInfo = uploadDeviceInfo;","map":{"version":3,"names":["uploadAllInfoAfter","after","store","getState","user","signingKey","keypair","publicKey","groups","recoveryData","channel","url","channelId","aesKey","isPrimaryDevice","settings","channelApi","ChannelAPI","href","console","log","retrieveImage","photo","filename","data","id","name","isSponsored","isSponsoredv6","backupCompleted","password","updateTimestamps","encrypted","encryptData","userDataId","IMPORT_PREFIX","b64ToUrlSafeB64","upload","dataId","connections","selectAllConnections","filter","conn","timestamp","uploadConnection","group","joined","uploadGroup","linkedContexts","selectAllLinkedContexts","linkedContext","dateAdded","state","contextInfo","uploadContextInfo","prefix","sigs","selectAllSigs","sig","signedTimestamp","linkedTimestamp","uploadBlindSig","completeDataId","uploadDeviceInfo","lastSyncTime","dataObj","JSON","stringify","requestedTtl","RECOVERY_CHANNEL_TTL"],"sources":["/home/ali/Desktop/brightid/BrightID/BrightID/src/components/Onboarding/ImportFlow/thunks/channelUploadThunks.ts"],"sourcesContent":["import { store } from '@/store';\nimport { b64ToUrlSafeB64 } from '@/utils/encoding';\nimport { encryptData } from '@/utils/cryptoHelper';\nimport { retrieveImage } from '@/utils/filesystem';\nimport { selectAllConnections } from '@/reducer/connectionsSlice';\nimport { selectAllLinkedContexts, selectAllSigs } from '@/reducer/appsSlice';\nimport ChannelAPI from '@/api/channelService';\nimport {\n  uploadBlindSig,\n  uploadConnection,\n  uploadContextInfo,\n  uploadGroup,\n} from '@/utils/channels';\nimport { IMPORT_PREFIX, RECOVERY_CHANNEL_TTL } from '@/utils/constants';\n\nexport const uploadAllInfoAfter = async (after) => {\n  const {\n    user,\n    keypair: { publicKey: signingKey },\n    groups: { groups },\n    recoveryData: {\n      channel: { url, channelId },\n      aesKey,\n    },\n    settings: { isPrimaryDevice },\n  } = store.getState();\n  // use keypair for sync and recovery for import\n  const channelApi = new ChannelAPI(url.href);\n\n  console.log('uploading user info');\n  const photo = await retrieveImage(user.photo.filename);\n  const data = {\n    id: user.id,\n    name: user.name,\n    photo,\n    isSponsored: user.isSponsored,\n    isSponsoredv6: user.isSponsoredv6,\n    backupCompleted: user.backupCompleted,\n    password: user.password,\n    updateTimestamps: user.updateTimestamps,\n  };\n\n  const encrypted = encryptData(data, aesKey);\n  const userDataId = `${IMPORT_PREFIX}userinfo_${user.id}:${b64ToUrlSafeB64(\n    signingKey,\n  )}`;\n  await channelApi.upload({\n    channelId,\n    dataId: userDataId,\n    data: encrypted,\n  });\n\n  console.log('uploading connections');\n  const connections = selectAllConnections(store.getState()).filter(\n    (conn) => conn.timestamp > after,\n  );\n  for (const conn of connections) {\n    await uploadConnection({\n      conn,\n      channelApi,\n      aesKey,\n      signingKey,\n    });\n  }\n\n  console.log('uploading groups');\n  for (const group of groups) {\n    if (group.joined > after) {\n      await uploadGroup({\n        group,\n        channelApi,\n        aesKey,\n        signingKey,\n      });\n    }\n  }\n\n  console.log('uploading linked contexts');\n  const linkedContexts = selectAllLinkedContexts(store.getState()).filter(\n    (linkedContext) =>\n      linkedContext.dateAdded > after && linkedContext.state === 'applied',\n  );\n  for (const contextInfo of linkedContexts) {\n    await uploadContextInfo({\n      contextInfo,\n      channelApi,\n      aesKey,\n      signingKey,\n      prefix: IMPORT_PREFIX,\n    });\n  }\n\n  console.log('uploading blind sigs');\n  if (isPrimaryDevice) {\n    const sigs = selectAllSigs(store.getState());\n    for (const sig of sigs) {\n      if (sig.signedTimestamp > after || sig.linkedTimestamp > after) {\n        await uploadBlindSig({\n          sig,\n          channelApi,\n          aesKey,\n          signingKey,\n          prefix: IMPORT_PREFIX,\n        });\n      }\n    }\n  }\n\n  console.log('uploading completed flag');\n  const completeDataId = `${IMPORT_PREFIX}completed_${\n    user.id\n  }:${b64ToUrlSafeB64(signingKey)}`;\n  await channelApi.upload({\n    channelId,\n    dataId: completeDataId,\n    data: 'completed',\n  });\n};\n\nexport const uploadDeviceInfo = async () => {\n  const {\n    recoveryData: {\n      channel: { url, channelId },\n      publicKey: signingKey,\n    },\n    settings: { lastSyncTime, isPrimaryDevice },\n  } = store.getState();\n  const dataObj: SyncDeviceInfo = { signingKey, lastSyncTime, isPrimaryDevice };\n  const data = JSON.stringify(dataObj);\n  const channelApi = new ChannelAPI(url.href);\n  await channelApi.upload({\n    channelId,\n    data,\n    dataId: `${IMPORT_PREFIX}data`,\n    requestedTtl: RECOVERY_CHANNEL_TTL,\n  });\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}