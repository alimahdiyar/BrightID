{"ast":null,"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.rootMigrate = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _reactNativeKeychain = require(\"react-native-keychain\");\n\nvar _ramda = require(\"ramda\");\n\nvar _encoding = require(\"../../utils/encoding\");\n\nvar _constants = require(\"../../utils/constants\");\n\nvar _deviceConstants = require(\"../../utils/deviceConstants\");\n\nvar _asyncCreateMigrate = require(\"./asyncCreateMigrate\");\n\nvar keyToString = (0, _ramda.compose)(_encoding.uInt8ArrayToB64, _encoding.objToUint8);\nvar rootMigrations = {\n  9: function _(state) {\n    var _await$getGenericPass, password;\n\n    return _regenerator.default.async(function _$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (!(!state.user.secretKey || typeof state.user.secretKey !== 'string')) {\n              _context.next = 6;\n              break;\n            }\n\n            _context.next = 3;\n            return _regenerator.default.awrap((0, _reactNativeKeychain.getGenericPassword)());\n\n          case 3:\n            _await$getGenericPass = _context.sent;\n            password = _await$getGenericPass.password;\n            state.user.secretKey = password;\n\n          case 6:\n            state.keypair = {\n              publicKey: state.user.publicKey,\n              secretKey: (0, _encoding.b64ToUint8Array)(state.user.secretKey)\n            };\n            delete state.user.publicKey;\n            delete state.user.secretKey;\n\n            if (state.notifications) {\n              delete state.notifications.miscAlreadyNotified;\n            }\n\n            state.user.migrated = true;\n            state.tasks = undefined;\n            return _context.abrupt(\"return\", state);\n\n          case 13:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  },\n  8: function _(state) {\n    var linkedContexts, genericPassword, password;\n    return _regenerator.default.async(function _$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            delete state.user.notifications;\n            delete state.connectQrData;\n            delete state.connectUserData;\n            linkedContexts = [];\n\n            if (state.apps.apps) {\n              linkedContexts = state.apps.apps.map(function (app) {\n                return {\n                  dateAdded: app.dateAdded || Date.now(),\n                  contextId: app.contextId,\n                  context: app.name,\n                  state: app.state\n                };\n              });\n            }\n\n            state.apps = {\n              apps: [],\n              linkedContexts: linkedContexts\n            };\n            _context2.prev = 6;\n            _context2.next = 9;\n            return _regenerator.default.awrap((0, _reactNativeKeychain.getGenericPassword)());\n\n          case 9:\n            genericPassword = _context2.sent;\n            password = genericPassword.password;\n\n            if (password) {\n              state.user.secretKey = password;\n            }\n\n            _context2.next = 18;\n            break;\n\n          case 14:\n            _context2.prev = 14;\n            _context2.t0 = _context2[\"catch\"](6);\n            console.log(_context2.t0.message);\n\n            if (state.user.secretKey) {\n              state.user.secretKey = keyToString(state.user.secretKey);\n            }\n\n          case 18:\n            return _context2.abrupt(\"return\", state);\n\n          case 19:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, null, null, [[6, 14]], Promise);\n  },\n  7: function _(state) {\n    return _regenerator.default.async(function _$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            delete state.channels;\n            delete state.pendingConnections;\n            delete state.notifications;\n            state.user.notifications = [];\n            state.connectQrData = {\n              myQrData: undefined,\n              peerQrData: {\n                aesKey: '',\n                ipAddress: '',\n                uuid: '',\n                qrString: '',\n                channel: '',\n                type: ''\n              }\n            };\n            state.connectUserData = {\n              id: '',\n              photo: '',\n              name: '',\n              timestamp: 0,\n              signedMessage: ''\n            };\n            return _context3.abrupt(\"return\", state);\n\n          case 7:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  },\n  6: function _(state) {\n    return _regenerator.default.async(function _$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            if (state.user) {\n              delete state.user.notifications;\n            }\n\n            delete state.connectQrData;\n            delete state.connectUserData;\n            return _context4.abrupt(\"return\", state);\n\n          case 4:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  },\n  5: function _(state) {\n    var _state$user, _state$user2, secretKey, opts;\n\n    return _regenerator.default.async(function _$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            _context5.prev = 0;\n            secretKey = (_state$user = state.user) == null ? void 0 : _state$user.secretKey;\n\n            if (!(secretKey && Object.keys(secretKey).length && (_state$user2 = state.user) != null && _state$user2.id)) {\n              _context5.next = 13;\n              break;\n            }\n\n            if (!_deviceConstants.DEVICE_ANDROID) {\n              _context5.next = 9;\n              break;\n            }\n\n            opts = {\n              rules: 'none'\n            };\n            _context5.next = 7;\n            return _regenerator.default.awrap((0, _reactNativeKeychain.setGenericPassword)(state.user.id, keyToString(secretKey), opts));\n\n          case 7:\n            _context5.next = 11;\n            break;\n\n          case 9:\n            _context5.next = 11;\n            return _regenerator.default.awrap((0, _reactNativeKeychain.setGenericPassword)(state.user.id, keyToString(secretKey)));\n\n          case 11:\n            _context5.next = 13;\n            return _regenerator.default.awrap((0, _reactNativeKeychain.setInternetCredentials)(_constants.BACKUP_URL, state.user.id, state.user.password));\n\n          case 13:\n            _context5.next = 19;\n            break;\n\n          case 15:\n            _context5.prev = 15;\n            _context5.t0 = _context5[\"catch\"](0);\n            console.log(_context5.t0.message);\n            alert('Unable to access device keychain, please let BrightID core team know about this issue..');\n\n          case 19:\n            state.user.secretKey = keyToString(state.user.secretKey);\n            return _context5.abrupt(\"return\", state);\n\n          case 21:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, null, null, [[0, 15]], Promise);\n  }\n};\nvar rootMigrate = (0, _asyncCreateMigrate.asyncCreateMigrate)(rootMigrations, {\n  debug: __DEV__\n});\nexports.rootMigrate = rootMigrate;","map":{"version":3,"names":["keyToString","compose","uInt8ArrayToB64","objToUint8","rootMigrations","state","user","secretKey","getGenericPassword","password","keypair","publicKey","b64ToUint8Array","notifications","miscAlreadyNotified","migrated","tasks","undefined","connectQrData","connectUserData","linkedContexts","apps","map","app","dateAdded","Date","now","contextId","context","name","genericPassword","console","log","message","channels","pendingConnections","myQrData","peerQrData","aesKey","ipAddress","uuid","qrString","channel","type","id","photo","timestamp","signedMessage","Object","keys","length","DEVICE_ANDROID","opts","rules","setGenericPassword","setInternetCredentials","BACKUP_URL","alert","rootMigrate","asyncCreateMigrate","debug","__DEV__"],"sources":["/home/ali/Desktop/brightid/BrightID/BrightID/src/store/migrations/root.js"],"sourcesContent":["import {\n  setInternetCredentials,\n  getGenericPassword,\n  setGenericPassword,\n} from 'react-native-keychain';\nimport { compose } from 'ramda';\nimport { objToUint8, uInt8ArrayToB64, b64ToUint8Array } from '@/utils/encoding';\nimport { BACKUP_URL } from '@/utils/constants';\nimport { DEVICE_ANDROID } from '@/utils/deviceConstants';\nimport { asyncCreateMigrate } from './asyncCreateMigrate';\n\nconst keyToString = compose(uInt8ArrayToB64, objToUint8);\n\n/** Async migration creators require every version to return a promiseÃŸ */\n\nconst rootMigrations = {\n  9: async (state) => {\n    // extract secretKey if not present\n    if (!state.user.secretKey || typeof state.user.secretKey !== 'string') {\n      let { password } = await getGenericPassword();\n      state.user.secretKey = password;\n    }\n\n    state.keypair = {\n      publicKey: state.user.publicKey,\n      secretKey: b64ToUint8Array(state.user.secretKey),\n    };\n\n    delete state.user.publicKey;\n    delete state.user.secretKey;\n    if (state.notifications) {\n      delete state.notifications.miscAlreadyNotified;\n    }\n\n    // add migration key for deleting AsyncStorage(persist:root)\n    state.user.migrated = true;\n    state.tasks = undefined;\n    return state;\n  },\n  8: async (state) => {\n    delete state.user.notifications;\n    delete state.connectQrData;\n    delete state.connectUserData;\n    // transfer linked contexts\n    let linkedContexts = [];\n    if (state.apps.apps) {\n      linkedContexts = state.apps.apps.map((app) => ({\n        dateAdded: app.dateAdded || Date.now(),\n        contextId: app.contextId,\n        context: app.name,\n        state: app.state,\n      }));\n    }\n\n    state.apps = {\n      apps: [],\n      linkedContexts,\n    };\n\n    // transfer secret key as backup\n    try {\n      let genericPassword = await getGenericPassword();\n      let { password } = genericPassword;\n      if (password) {\n        state.user.secretKey = password;\n      }\n    } catch (err) {\n      console.log(err.message);\n      if (state.user.secretKey) {\n        state.user.secretKey = keyToString(state.user.secretKey);\n      }\n    }\n\n    return state;\n  },\n  7: async (state) => {\n    delete state.channels;\n    delete state.pendingConnections;\n    delete state.notifications;\n    state.user.notifications = [];\n    state.connectQrData = {\n      myQrData: undefined,\n      peerQrData: {\n        aesKey: '',\n        ipAddress: '',\n        uuid: '',\n        qrString: '',\n        channel: '',\n        type: '',\n      },\n    };\n    state.connectUserData = {\n      id: '',\n      photo: '',\n      name: '',\n      timestamp: 0,\n      signedMessage: '',\n    };\n    return state;\n  },\n  6: async (state) => {\n    if (state.user) {\n      delete state.user.notifications;\n    }\n\n    delete state.connectQrData;\n    delete state.connectUserData;\n    return state;\n  },\n  5: async (state) => {\n    try {\n      // secret key defaults to empty object\n      let secretKey = state.user?.secretKey;\n      if (secretKey && Object.keys(secretKey).length && state.user?.id) {\n        // save secret key in keychain storage\n\n        if (DEVICE_ANDROID) {\n          let opts = { rules: 'none' };\n          await setGenericPassword(state.user.id, keyToString(secretKey), opts);\n        } else {\n          await setGenericPassword(state.user.id, keyToString(secretKey));\n        }\n\n        // save backup password\n        await setInternetCredentials(\n          BACKUP_URL,\n          state.user.id,\n          state.user.password,\n        );\n      }\n    } catch (err) {\n      console.log(err.message);\n      alert(\n        'Unable to access device keychain, please let BrightID core team know about this issue..',\n      );\n    }\n    state.user.secretKey = keyToString(state.user.secretKey);\n    return state;\n  },\n};\n\nexport const rootMigrate = asyncCreateMigrate(rootMigrations, {\n  debug: __DEV__,\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}