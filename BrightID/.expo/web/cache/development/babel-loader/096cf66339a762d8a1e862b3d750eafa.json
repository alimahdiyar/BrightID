{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\n\nfunction _createForOfIteratorHelperLoose(o, allowArrayLike) {\n  var it = typeof Symbol !== \"undefined\" && o[Symbol.iterator] || o[\"@@iterator\"];\n  if (it) return (it = it.call(o)).next.bind(it);\n\n  if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") {\n    if (it) o = it;\n    var i = 0;\n    return function () {\n      if (i >= o.length) return {\n        done: true\n      };\n      return {\n        done: false,\n        value: o[i++]\n      };\n    };\n  }\n\n  throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nimport Alert from \"react-native-web/dist/exports/Alert\";\nimport { find, propEq } from 'ramda';\nimport i18next from 'i18next';\nimport { create } from 'apisauce';\nimport { addLinkedContext, addOperation, selectIsPrimaryDevice, setIsSponsoredv6, updateBlindSig, updateSig } from \"../../actions\";\nimport store from \"../../store\";\nimport { NodeApi } from \"../../api/brightId\";\nimport { selectAllSigs } from \"../../reducer/appsSlice\";\nimport BrightidError, { APP_ID_NOT_FOUND } from \"../../api/brightidError\";\nimport { BrightIdNetwork } from \"./types.d\";\nvar sponsorTimeout = 1000 * 60;\nvar sponsorPollInterval = 3000;\nexport var getSignedTimestamp = function getSignedTimestamp(app) {\n  var sigs = selectAllSigs(store.getState());\n  var vel = app.verificationExpirationLength;\n  var roundedTimestamp = vel ? Math.floor(Date.now() / vel) * vel : 0;\n\n  var _loop = function _loop(verification) {\n    var sigInfo = sigs.find(function (sig) {\n      return sig.app === app.id && sig.verification === verification && sig.roundedTimestamp === roundedTimestamp;\n    });\n\n    if (sigInfo && sigInfo.sig) {\n      return {\n        v: sigInfo.signedTimestamp\n      };\n    }\n  };\n\n  for (var _iterator = _createForOfIteratorHelperLoose(app.verifications), _step; !(_step = _iterator()).done;) {\n    var verification = _step.value;\n\n    var _ret = _loop(verification);\n\n    if (typeof _ret === \"object\") return _ret.v;\n  }\n\n  return null;\n};\nexport var handleV5App = function _callee(params, setSponsoringApp, api) {\n  var _store$getState, apps, handler, appInfo, baseUrl, appId, appUserId, _baseUrl, context, contextId;\n\n  return _regeneratorRuntime.async(function _callee$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          _store$getState = store.getState(), apps = _store$getState.apps.apps;\n          params.baseUrl = decodeURIComponent(params.baseUrl);\n          appInfo = find(propEq('id', params.context))(apps);\n\n          if (appInfo && appInfo.soulbound) {\n            baseUrl = params.baseUrl, appId = params.context, appUserId = params.contextId;\n\n            handler = function handler() {\n              return sponsor(appId, appUserId, setSponsoringApp, api, function () {\n                return linkContextId(baseUrl, appId, appUserId);\n              });\n            };\n          } else {\n            _baseUrl = params.baseUrl, context = params.context, contextId = params.contextId;\n\n            handler = function handler() {\n              return linkContextId(_baseUrl, context, contextId);\n            };\n          }\n\n          Alert.alert(i18next.t('apps.alert.title.linkApp'), i18next.t('apps.alert.text.linkApp', {\n            context: \"\" + params.context\n          }), [{\n            text: i18next.t('common.alert.yes'),\n            onPress: handler\n          }, {\n            text: i18next.t('common.alert.no'),\n            style: 'cancel',\n            onPress: function onPress() {\n              return null;\n            }\n          }]);\n\n        case 5:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, null, null, null, Promise);\n};\nexport var handleV6App = function _callee2(params, setSponsoringApp, api) {\n  var appId, appUserId;\n  return _regeneratorRuntime.async(function _callee2$(_context2) {\n    while (1) {\n      switch (_context2.prev = _context2.next) {\n        case 0:\n          appId = params.context, appUserId = params.contextId;\n          Alert.alert(i18next.t('apps.alert.title.linkApp'), i18next.t('apps.alert.text.linkApp', {\n            context: \"\" + appId\n          }), [{\n            text: i18next.t('common.alert.yes'),\n            onPress: function onPress() {\n              sponsor(appId, appUserId, setSponsoringApp, api, function () {\n                return linkAppId(appId, appUserId);\n              });\n            }\n          }, {\n            text: i18next.t('common.alert.no'),\n            style: 'cancel',\n            onPress: function onPress() {\n              return null;\n            }\n          }]);\n\n        case 2:\n        case \"end\":\n          return _context2.stop();\n      }\n    }\n  }, null, null, null, Promise);\n};\n\nvar linkContextId = function _callee3(baseUrl, context, contextId) {\n  var id, secretKey, api, op;\n  return _regeneratorRuntime.async(function _callee3$(_context3) {\n    while (1) {\n      switch (_context3.prev = _context3.next) {\n        case 0:\n          id = store.getState().user.id;\n          secretKey = store.getState().keypair.secretKey;\n          api = new NodeApi({\n            url: baseUrl,\n            id: id,\n            secretKey: secretKey\n          });\n          _context3.prev = 3;\n          _context3.next = 6;\n          return _regeneratorRuntime.awrap(api.linkContextId(context, contextId));\n\n        case 6:\n          op = _context3.sent;\n          op.apiUrl = baseUrl;\n          store.dispatch(addOperation(op));\n          store.dispatch(addLinkedContext({\n            context: context,\n            contextId: contextId,\n            dateAdded: Date.now(),\n            state: 'pending'\n          }));\n          _context3.next = 15;\n          break;\n\n        case 12:\n          _context3.prev = 12;\n          _context3.t0 = _context3[\"catch\"](3);\n          Alert.alert(i18next.t('apps.alert.title.linkingFailed'), \"\" + _context3.t0.message, [{\n            text: i18next.t('common.alert.dismiss'),\n            style: 'cancel',\n            onPress: function onPress() {\n              return null;\n            }\n          }]);\n\n        case 15:\n        case \"end\":\n          return _context3.stop();\n      }\n    }\n  }, null, null, [[3, 12]], Promise);\n};\n\nexport var linkAppId = function _callee5(appId, appUserId) {\n  var silent,\n      _store$getState2,\n      apps,\n      id,\n      secretKey,\n      appInfo,\n      vel,\n      roundedTimestamp,\n      network,\n      onSuccess,\n      previousSigs,\n      sigs,\n      previousAppUserIds,\n      _iterator2,\n      _step2,\n      previousSig,\n      allVerificationsLinked,\n      missingVerifications,\n      linkedVerifications,\n      isPrimary,\n      missingSigs,\n      url,\n      api,\n      linkedTimestamp,\n      linkSuccess,\n      _iterator6,\n      _step6,\n      sig,\n      msg,\n      _args5 = arguments;\n\n  return _regeneratorRuntime.async(function _callee5$(_context5) {\n    while (1) {\n      switch (_context5.prev = _context5.next) {\n        case 0:\n          silent = _args5.length > 2 && _args5[2] !== undefined ? _args5[2] : false;\n          _store$getState2 = store.getState(), apps = _store$getState2.apps.apps, id = _store$getState2.user.id, secretKey = _store$getState2.keypair.secretKey;\n          appInfo = find(propEq('id', appId))(apps);\n          vel = appInfo.verificationExpirationLength;\n          roundedTimestamp = vel ? Math.floor(Date.now() / vel) * vel : 0;\n          network = __DEV__ ? BrightIdNetwork.TEST : BrightIdNetwork.NODE;\n\n          onSuccess = function _callee4() {\n            var _api;\n\n            return _regeneratorRuntime.async(function _callee4$(_context4) {\n              while (1) {\n                switch (_context4.prev = _context4.next) {\n                  case 0:\n                    if (!appInfo.callbackUrl) {\n                      _context4.next = 4;\n                      break;\n                    }\n\n                    _api = create({\n                      baseURL: appInfo.callbackUrl\n                    });\n                    _context4.next = 4;\n                    return _regeneratorRuntime.awrap(_api.post('/', {\n                      network: network,\n                      appUserId: appUserId\n                    }));\n\n                  case 4:\n                  case \"end\":\n                    return _context4.stop();\n                }\n              }\n            }, null, null, null, Promise);\n          };\n\n          _context5.next = 9;\n          return _regeneratorRuntime.awrap(store.dispatch(updateBlindSig(appInfo)));\n\n        case 9:\n          previousSigs = selectAllSigs(store.getState()).filter(function (sig) {\n            return sig.app === appId && sig.linked === true && sig.roundedTimestamp === roundedTimestamp;\n          });\n          sigs = selectAllSigs(store.getState()).filter(function (sig) {\n            return sig.app === appId && sig.linked === false && sig.roundedTimestamp === roundedTimestamp;\n          });\n\n          if (!previousSigs.length) {\n            _context5.next = 21;\n            break;\n          }\n\n          previousAppUserIds = new Set();\n\n          for (_iterator2 = _createForOfIteratorHelperLoose(previousSigs); !(_step2 = _iterator2()).done;) {\n            previousSig = _step2.value;\n\n            if (previousSig.appUserId !== appUserId) {\n              previousAppUserIds.add(previousSig.appUserId);\n            }\n          }\n\n          if (!previousAppUserIds.size) {\n            _context5.next = 17;\n            break;\n          }\n\n          if (!silent) {\n            Alert.alert(i18next.t('apps.alert.title.linkingFailed'), i18next.t('apps.alert.text.blindSigAlreadyLinkedDifferent', 'You are trying to link with {{app}} using {{appUserId}}. You are already linked with {{app}} with different id {{previousAppUserIds}}. This may lead to problems using the app.', {\n              app: appId,\n              appUserId: appUserId,\n              previousAppUserIds: Array.from(previousAppUserIds).join(', ')\n            }));\n          }\n\n          return _context5.abrupt(\"return\", false);\n\n        case 17:\n          allVerificationsLinked = appInfo.verifications.every(function (verification) {\n            for (var _iterator3 = _createForOfIteratorHelperLoose(previousSigs), _step3; !(_step3 = _iterator3()).done;) {\n              var prevSig = _step3.value;\n              if (prevSig.verification === verification) return true;\n            }\n\n            return false;\n          });\n\n          if (!allVerificationsLinked) {\n            _context5.next = 21;\n            break;\n          }\n\n          if (!silent) {\n            Alert.alert(i18next.t('apps.alert.title.linkingFailed'), i18next.t('apps.alert.text.blindSigAlreadyLinked', 'You are already linked with {{app}} with id {{appUserId}}', {\n              app: appId,\n              appUserId: appUserId\n            }));\n          }\n\n          return _context5.abrupt(\"return\", false);\n\n        case 21:\n          missingVerifications = appInfo.verifications.filter(function (verification) {\n            for (var _iterator4 = _createForOfIteratorHelperLoose(previousSigs), _step4; !(_step4 = _iterator4()).done;) {\n              var prevSig = _step4.value;\n\n              if (prevSig.verification === verification) {\n                console.log(\"Verification \" + verification + \" already linked with sig \" + prevSig.uid);\n                return false;\n              }\n            }\n\n            for (var _iterator5 = _createForOfIteratorHelperLoose(sigs), _step5; !(_step5 = _iterator5()).done;) {\n              var sig = _step5.value;\n\n              if (sig.verification === verification) {\n                console.log(\"Verification \" + verification + \" has sig available and ready to link\");\n                return false;\n              }\n            }\n\n            console.log(\"Verification \" + verification + \" is missing\");\n            return true;\n          });\n          linkedVerifications = previousSigs.map(function (sig) {\n            return sig.verification;\n          });\n\n          if (!(sigs.length === 0)) {\n            _context5.next = 26;\n            break;\n          }\n\n          if (!silent) {\n            Alert.alert(i18next.t('apps.alert.title.linkingFailed'), i18next.t('apps.alert.text.missingBlindSig', 'No blind sig found for app {{appId}}. Verifications missing: {{missingVerifications}}. Verifications already linked: {{linkedVerifications}}', {\n              appId: appId,\n              missingVerifications: missingVerifications.join(),\n              linkedVerifications: linkedVerifications.join()\n            }), [{\n              text: i18next.t('common.alert.dismiss'),\n              style: 'cancel',\n              onPress: function onPress() {\n                return null;\n              }\n            }]);\n          }\n\n          return _context5.abrupt(\"return\", false);\n\n        case 26:\n          isPrimary = selectIsPrimaryDevice(store.getState());\n\n          if (isPrimary) {\n            _context5.next = 32;\n            break;\n          }\n\n          missingSigs = sigs.filter(function (sig) {\n            return sig.sig === undefined;\n          });\n\n          if (!missingSigs.length) {\n            _context5.next = 32;\n            break;\n          }\n\n          if (!silent) {\n            Alert.alert(i18next.t('apps.alert.title.notPrimary', 'Linking not possible'), i18next.t('apps.alert.text.notPrimary', 'You are currently using a secondary device. Linking app \"{{app}}\" requires interaction with your primary device. Please sync with your primary device or perform the linking with your primary device.', {\n              app: \"\" + appId\n            }));\n          }\n\n          return _context5.abrupt(\"return\", false);\n\n        case 32:\n          url = appInfo.nodeUrl || \"http://\" + network + \".brightid.org\";\n          api = new NodeApi({\n            url: url,\n            id: id,\n            secretKey: secretKey\n          });\n          linkedTimestamp = Date.now();\n          linkSuccess = false;\n          _iterator6 = _createForOfIteratorHelperLoose(sigs);\n\n        case 37:\n          if ((_step6 = _iterator6()).done) {\n            _context5.next = 53;\n            break;\n          }\n\n          sig = _step6.value;\n          _context5.prev = 39;\n          _context5.next = 42;\n          return _regeneratorRuntime.awrap(api.linkAppId(sig, appUserId));\n\n        case 42:\n          store.dispatch(updateSig({\n            id: sig.uid,\n            changes: {\n              linked: true,\n              linkedTimestamp: linkedTimestamp,\n              appUserId: appUserId\n            }\n          }));\n          linkSuccess = true;\n          _context5.next = 51;\n          break;\n\n        case 46:\n          _context5.prev = 46;\n          _context5.t0 = _context5[\"catch\"](39);\n          console.log(_context5.t0);\n          msg = _context5.t0 instanceof Error ? _context5.t0.message : _context5.t0;\n\n          if (!silent) {\n            Alert.alert(i18next.t('apps.alert.title.linkingFailed'), i18next.t('apps.alert.text.linkSigFailed', 'Error linking verification {{verification}} to app {{appId}}. Error message: {{msg}}', {\n              verification: sig.verification,\n              appId: appId,\n              msg: msg\n            }), [{\n              text: i18next.t('common.alert.dismiss'),\n              style: 'cancel',\n              onPress: function onPress() {\n                return null;\n              }\n            }]);\n          }\n\n        case 51:\n          _context5.next = 37;\n          break;\n\n        case 53:\n          if (!linkSuccess) {\n            _context5.next = 57;\n            break;\n          }\n\n          if (!silent) {\n            Alert.alert(i18next.t('apps.alert.title.linkSuccess'), i18next.t('apps.alert.text.linkSuccess', {\n              context: appInfo.name\n            }));\n          }\n\n          onSuccess();\n          return _context5.abrupt(\"return\", true);\n\n        case 57:\n          return _context5.abrupt(\"return\", false);\n\n        case 58:\n        case \"end\":\n          return _context5.stop();\n      }\n    }\n  }, null, null, [[39, 46]], Promise);\n};\n\nvar getSponsorship = function _callee6(appUserId, api) {\n  return _regeneratorRuntime.async(function _callee6$(_context6) {\n    while (1) {\n      switch (_context6.prev = _context6.next) {\n        case 0:\n          _context6.prev = 0;\n          _context6.next = 3;\n          return _regeneratorRuntime.awrap(api.getSponsorship(appUserId));\n\n        case 3:\n          return _context6.abrupt(\"return\", _context6.sent);\n\n        case 6:\n          _context6.prev = 6;\n          _context6.t0 = _context6[\"catch\"](0);\n\n          if (!(_context6.t0 instanceof BrightidError && _context6.t0.errorNum === APP_ID_NOT_FOUND)) {\n            _context6.next = 12;\n            break;\n          }\n\n          console.log(\"sponsor request for \" + appUserId + \" not yet existing\");\n          _context6.next = 13;\n          break;\n\n        case 12:\n          throw _context6.t0;\n\n        case 13:\n        case \"end\":\n          return _context6.stop();\n      }\n    }\n  }, null, null, [[0, 6]], Promise);\n};\n\nvar sponsor = function _callee8(appId, appUserId, setSponsoringApp, api, onSuccess) {\n  var _store$getState3, apps, _store$getState3$user, isSponsored, isSponsoredv6, sp, appInfo, op, msg;\n\n  return _regeneratorRuntime.async(function _callee8$(_context8) {\n    while (1) {\n      switch (_context8.prev = _context8.next) {\n        case 0:\n          _store$getState3 = store.getState(), apps = _store$getState3.apps.apps, _store$getState3$user = _store$getState3.user, isSponsored = _store$getState3$user.isSponsored, isSponsoredv6 = _store$getState3$user.isSponsoredv6;\n\n          if (!(isSponsored || isSponsoredv6)) {\n            _context8.next = 4;\n            break;\n          }\n\n          onSuccess();\n          return _context8.abrupt(\"return\");\n\n        case 4:\n          _context8.next = 6;\n          return _regeneratorRuntime.awrap(getSponsorship(appUserId, api));\n\n        case 6:\n          sp = _context8.sent;\n\n          if (!(sp && sp.appHasAuthorized && sp.spendRequested)) {\n            _context8.next = 11;\n            break;\n          }\n\n          console.log('the appUserId is used by another user to get sponsored before.');\n          Alert.alert(i18next.t('apps.alert.title.linkingFailed'), i18next.t('apps.alert.text.duplicateAppUserId', {\n            appUserId: appUserId\n          }));\n          return _context8.abrupt(\"return\");\n\n        case 11:\n          appInfo = find(propEq('id', appId))(apps);\n          setSponsoringApp(appInfo);\n          console.log(\"Sending spend sponsorship op...\");\n          _context8.next = 16;\n          return _regeneratorRuntime.awrap(api.spendSponsorship(appId, appUserId));\n\n        case 16:\n          op = _context8.sent;\n          _context8.prev = 17;\n          _context8.next = 20;\n          return _regeneratorRuntime.awrap(new Promise(function (resolve, reject) {\n            var startTime = Date.now();\n            var intervalId = setInterval(function _callee7() {\n              var timeElapsed, _sp;\n\n              return _regeneratorRuntime.async(function _callee7$(_context7) {\n                while (1) {\n                  switch (_context7.prev = _context7.next) {\n                    case 0:\n                      timeElapsed = Date.now() - startTime;\n\n                      if (!(timeElapsed > sponsorTimeout)) {\n                        _context7.next = 6;\n                        break;\n                      }\n\n                      clearInterval(intervalId);\n                      reject(new Error(\"Timeout waiting for sponsorship\"));\n                      _context7.next = 11;\n                      break;\n\n                    case 6:\n                      _context7.next = 8;\n                      return _regeneratorRuntime.awrap(getSponsorship(appUserId, api));\n\n                    case 8:\n                      _sp = _context7.sent;\n                      console.log(\"Got sponsorRes: \" + _sp);\n\n                      if (_sp && _sp.appHasAuthorized && _sp.spendRequested) {\n                        console.log(\"Sponsorship complete!\");\n                        clearInterval(intervalId);\n                        resolve();\n                      }\n\n                    case 11:\n                    case \"end\":\n                      return _context7.stop();\n                  }\n                }\n              }, null, null, null, Promise);\n            }, sponsorPollInterval);\n          }));\n\n        case 20:\n          store.dispatch(setIsSponsoredv6(true));\n          setSponsoringApp(undefined);\n          onSuccess();\n          _context8.next = 30;\n          break;\n\n        case 25:\n          _context8.prev = 25;\n          _context8.t0 = _context8[\"catch\"](17);\n          msg = _context8.t0 instanceof Error ? _context8.t0.message : _context8.t0;\n          console.log(\"Error getting sponsored: \" + msg);\n          Alert.alert(i18next.t('apps.alert.title.linkingFailed'), \"\" + msg, [{\n            text: i18next.t('common.alert.dismiss'),\n            style: 'cancel',\n            onPress: function onPress() {\n              return null;\n            }\n          }]);\n\n        case 30:\n        case \"end\":\n          return _context8.stop();\n      }\n    }\n  }, null, null, [[17, 25]], Promise);\n};","map":{"version":3,"sources":["/home/ali/Desktop/brightid/BrightID/BrightID/src/components/Apps/model.ts"],"names":["sponsorTimeout","sponsorPollInterval","getSignedTimestamp","sigs","selectAllSigs","store","vel","app","roundedTimestamp","Math","Date","verification","sigInfo","sig","handleV5App","apps","params","decodeURIComponent","appInfo","find","propEq","baseUrl","appId","appUserId","handler","sponsor","linkContextId","context","contextId","Alert","i18next","text","onPress","style","handleV6App","linkAppId","id","secretKey","api","url","op","addOperation","addLinkedContext","dateAdded","state","silent","network","__DEV__","BrightIdNetwork","onSuccess","create","baseURL","updateBlindSig","previousSigs","previousAppUserIds","previousSig","Array","allVerificationsLinked","prevSig","missingVerifications","console","linkedVerifications","isPrimary","selectIsPrimaryDevice","missingSigs","linkedTimestamp","linkSuccess","updateSig","changes","linked","msg","getSponsorship","isSponsored","isSponsoredv6","sp","setSponsoringApp","startTime","intervalId","setInterval","timeElapsed","clearInterval","reject","resolve","setIsSponsoredv6"],"mappings":"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","sourcesContent":["import { Alert } from 'react-native';\nimport { find, propEq } from 'ramda';\nimport i18next from 'i18next';\nimport { create } from 'apisauce';\nimport { Dispatch, SetStateAction } from 'react';\nimport {\n  addLinkedContext,\n  addOperation,\n  selectIsPrimaryDevice,\n  setIsSponsoredv6,\n  updateBlindSig,\n  updateSig,\n} from '@/actions';\nimport store from '@/store';\nimport { NodeApi } from '@/api/brightId';\nimport { selectAllSigs } from '@/reducer/appsSlice';\nimport BrightidError, { APP_ID_NOT_FOUND } from '@/api/brightidError';\nimport { BrightIdNetwork, Params } from '@/components/Apps/types.d';\n\n// max time to wait for app to respond to sponsoring request\nconst sponsorTimeout = 1000 * 60; // 60 seconds\n// Interval to poll for sponsor op\nconst sponsorPollInterval = 3000; // 5 seconds\n\nexport const getSignedTimestamp = (app: AppInfo) => {\n  const sigs = selectAllSigs(store.getState());\n  const vel = app.verificationExpirationLength;\n  const roundedTimestamp = vel ? Math.floor(Date.now() / vel) * vel : 0;\n  for (const verification of app.verifications) {\n    const sigInfo = sigs.find(\n      (sig) =>\n        sig.app === app.id &&\n        sig.verification === verification &&\n        sig.roundedTimestamp === roundedTimestamp,\n    );\n    if (sigInfo && sigInfo.sig) {\n      return sigInfo.signedTimestamp;\n    }\n  }\n  return null;\n};\n\nexport const handleV5App = async (\n  params: Params,\n  setSponsoringApp: Dispatch<SetStateAction<AppInfo>>,\n  api: NodeApi,\n) => {\n  const {\n    apps: { apps },\n  } = store.getState();\n  let handler: () => Promise<void>;\n  params.baseUrl = decodeURIComponent(params.baseUrl);\n  const appInfo = find(propEq('id', params.context))(apps) as AppInfo;\n  if (appInfo && appInfo.soulbound) {\n    // soulbound apps link after sponsorship just like v6 apps\n    const { baseUrl, context: appId, contextId: appUserId } = params;\n    handler = () =>\n      sponsor(appId, appUserId, setSponsoringApp, api, () =>\n        linkContextId(baseUrl, appId, appUserId),\n      );\n  } else {\n    const { baseUrl, context, contextId } = params;\n    handler = () => linkContextId(baseUrl, context, contextId);\n  }\n  Alert.alert(\n    i18next.t('apps.alert.title.linkApp'),\n    i18next.t('apps.alert.text.linkApp', { context: `${params.context}` }),\n    [\n      {\n        text: i18next.t('common.alert.yes'),\n        onPress: handler,\n      },\n      {\n        text: i18next.t('common.alert.no'),\n        style: 'cancel',\n        onPress: () => null,\n      },\n    ],\n  );\n};\n\nexport const handleV6App = async (\n  params: Params,\n  setSponsoringApp,\n  api: NodeApi,\n) => {\n  const { context: appId, contextId: appUserId } = params;\n  Alert.alert(\n    i18next.t('apps.alert.title.linkApp'),\n    i18next.t('apps.alert.text.linkApp', { context: `${appId}` }),\n    [\n      {\n        text: i18next.t('common.alert.yes'),\n        onPress: () => {\n          sponsor(appId, appUserId, setSponsoringApp, api, () =>\n            linkAppId(appId, appUserId),\n          );\n        },\n      },\n      {\n        text: i18next.t('common.alert.no'),\n        style: 'cancel',\n        onPress: () => null,\n      },\n    ],\n  );\n};\n\nconst linkContextId = async (\n  baseUrl: string,\n  context: string,\n  contextId: string,\n) => {\n  // Create temporary NodeAPI object, since only the node at the specified baseUrl knows about this context\n  const { id } = store.getState().user;\n  const { secretKey } = store.getState().keypair;\n  const api = new NodeApi({ url: baseUrl, id, secretKey });\n  try {\n    const op = await api.linkContextId(context, contextId);\n    op.apiUrl = baseUrl;\n    store.dispatch(addOperation(op));\n    store.dispatch(\n      addLinkedContext({\n        context,\n        contextId,\n        dateAdded: Date.now(),\n        state: 'pending',\n      }),\n    );\n  } catch (e) {\n    Alert.alert(\n      i18next.t('apps.alert.title.linkingFailed'),\n      `${(e as Error).message}`,\n      [\n        {\n          text: i18next.t('common.alert.dismiss'),\n          style: 'cancel',\n          onPress: () => null,\n        },\n      ],\n    );\n  }\n};\n\nexport const linkAppId = async (\n  appId: string,\n  appUserId: string,\n  silent = false,\n) => {\n  const {\n    apps: { apps },\n    user: { id },\n    keypair: { secretKey },\n  } = store.getState();\n  const appInfo = find(propEq('id', appId))(apps) as AppInfo;\n  const vel = appInfo.verificationExpirationLength;\n  const roundedTimestamp = vel ? Math.floor(Date.now() / vel) * vel : 0;\n  const network = __DEV__ ? BrightIdNetwork.TEST : BrightIdNetwork.NODE;\n\n  const onSuccess = async () => {\n    if (appInfo.callbackUrl) {\n      const api = create({\n        baseURL: appInfo.callbackUrl,\n      });\n      await api.post('/', {\n        network,\n        appUserId,\n      });\n    }\n  };\n\n  // generate blind sig for apps with no verification expiration at linking time\n  // and also ensure blind sig is not missed because of delay in generation for all apps\n  await store.dispatch(updateBlindSig(appInfo));\n  // existing linked verifications\n  const previousSigs = selectAllSigs(store.getState()).filter(\n    (sig) =>\n      sig.app === appId &&\n      sig.linked === true &&\n      sig.roundedTimestamp === roundedTimestamp,\n  );\n  // not yet linked verifications\n  const sigs = selectAllSigs(store.getState()).filter(\n    (sig) =>\n      sig.app === appId &&\n      sig.linked === false &&\n      sig.roundedTimestamp === roundedTimestamp,\n  );\n\n  // make sure that always the same appUserId is used.\n  if (previousSigs.length) {\n    const previousAppUserIds: Set<string> = new Set();\n    for (const previousSig of previousSigs) {\n      if (previousSig.appUserId !== appUserId) {\n        previousAppUserIds.add(previousSig.appUserId);\n      }\n    }\n    if (previousAppUserIds.size) {\n      if (!silent) {\n        Alert.alert(\n          i18next.t('apps.alert.title.linkingFailed'),\n          i18next.t(\n            'apps.alert.text.blindSigAlreadyLinkedDifferent',\n            'You are trying to link with {{app}} using {{appUserId}}. You are already linked with {{app}} with different id {{previousAppUserIds}}. This may lead to problems using the app.',\n            {\n              app: appId,\n              appUserId,\n              previousAppUserIds: Array.from(previousAppUserIds).join(', '),\n            },\n          ),\n        );\n      }\n      return false; // don't link app when userId is different\n    }\n\n    // check if all app verifications are already linked\n    const allVerificationsLinked = appInfo.verifications.every(\n      (verification) => {\n        for (const prevSig of previousSigs) {\n          if (prevSig.verification === verification) return true;\n        }\n        return false;\n      },\n    );\n    if (allVerificationsLinked) {\n      if (!silent) {\n        Alert.alert(\n          i18next.t('apps.alert.title.linkingFailed'),\n          i18next.t(\n            'apps.alert.text.blindSigAlreadyLinked',\n            'You are already linked with {{app}} with id {{appUserId}}',\n            { app: appId, appUserId },\n          ),\n        );\n      }\n      return false;\n    }\n  }\n\n  // get list of all missing verifications\n  const missingVerifications = appInfo.verifications.filter((verification) => {\n    // exclude verification if it is already linked\n    for (const prevSig of previousSigs) {\n      if (prevSig.verification === verification) {\n        console.log(\n          `Verification ${verification} already linked with sig ${prevSig.uid}`,\n        );\n        return false;\n      }\n    }\n    // exclude verification if not yet linked, but sig is available\n    for (const sig of sigs) {\n      if (sig.verification === verification) {\n        console.log(\n          `Verification ${verification} has sig available and ready to link`,\n        );\n        return false;\n      }\n    }\n    console.log(`Verification ${verification} is missing`);\n    return true;\n  });\n\n  // get list of all already linked verifications\n  const linkedVerifications = previousSigs.map((sig) => sig.verification);\n\n  if (sigs.length === 0) {\n    if (!silent) {\n      Alert.alert(\n        i18next.t('apps.alert.title.linkingFailed'),\n        i18next.t(\n          'apps.alert.text.missingBlindSig',\n          'No blind sig found for app {{appId}}. Verifications missing: {{missingVerifications}}. Verifications already linked: {{linkedVerifications}}',\n          {\n            appId,\n            missingVerifications: missingVerifications.join(),\n            linkedVerifications: linkedVerifications.join(),\n          },\n        ),\n        [\n          {\n            text: i18next.t('common.alert.dismiss'),\n            style: 'cancel',\n            onPress: () => null,\n          },\n        ],\n      );\n    }\n    return false;\n  }\n\n  // check if blind sigs are existing if this is a secondary device\n  const isPrimary = selectIsPrimaryDevice(store.getState());\n  if (!isPrimary) {\n    const missingSigs = sigs.filter((sig) => sig.sig === undefined);\n    if (missingSigs.length) {\n      if (!silent) {\n        Alert.alert(\n          i18next.t('apps.alert.title.notPrimary', 'Linking not possible'),\n          i18next.t(\n            'apps.alert.text.notPrimary',\n            'You are currently using a secondary device. Linking app \"{{app}}\" requires interaction with your primary device. Please sync with your primary device or perform the linking with your primary device.',\n            { app: `${appId}` },\n          ),\n        );\n      }\n      return false;\n    }\n  }\n\n  // Create temporary NodeAPI object, since the node at the specified nodeUrl will\n  // be queried for the verification\n  const url = appInfo.nodeUrl || `http://${network}.brightid.org`;\n  const api = new NodeApi({ url, id, secretKey });\n  const linkedTimestamp = Date.now();\n  let linkSuccess = false;\n  for (const sig of sigs) {\n    try {\n      await api.linkAppId(sig, appUserId);\n      // mark sig as linked with app\n      store.dispatch(\n        updateSig({\n          id: sig.uid,\n          changes: { linked: true, linkedTimestamp, appUserId },\n        }),\n      );\n      linkSuccess = true;\n    } catch (err) {\n      console.log(err);\n      const msg = err instanceof Error ? err.message : err;\n      if (!silent) {\n        Alert.alert(\n          i18next.t('apps.alert.title.linkingFailed'),\n          i18next.t(\n            'apps.alert.text.linkSigFailed',\n            'Error linking verification {{verification}} to app {{appId}}. Error message: {{msg}}',\n            { verification: sig.verification, appId, msg },\n          ),\n          [\n            {\n              text: i18next.t('common.alert.dismiss'),\n              style: 'cancel',\n              onPress: () => null,\n            },\n          ],\n        );\n      }\n    }\n  }\n\n  if (linkSuccess) {\n    if (!silent) {\n      Alert.alert(\n        i18next.t('apps.alert.title.linkSuccess'),\n        i18next.t('apps.alert.text.linkSuccess', {\n          context: appInfo.name,\n        }),\n      );\n    }\n    onSuccess();\n    return true;\n  }\n  return false;\n};\n\nconst getSponsorship = async (appUserId: string, api: NodeApi) => {\n  try {\n    return await api.getSponsorship(appUserId);\n  } catch (e) {\n    if (e instanceof BrightidError && e.errorNum === APP_ID_NOT_FOUND) {\n      // node has not yet registered the sponsor request -> Ignore\n      console.log(`sponsor request for ${appUserId} not yet existing`);\n    } else {\n      throw e;\n    }\n  }\n};\n\nconst sponsor = async (\n  appId: string,\n  appUserId: string,\n  setSponsoringApp,\n  api: NodeApi,\n  onSuccess: () => any,\n) => {\n  const {\n    apps: { apps },\n    user: { isSponsored, isSponsoredv6 },\n  } = store.getState();\n  if (isSponsored || isSponsoredv6) {\n    onSuccess();\n    return;\n  }\n  /*\n  1. get appId from deep link\n  2. already Sponsored? yes: go to step 6. no: go to step 3.\n  3. ensure no one else is sponsored using this appId before\n  4. optimistically send Spend Sponsorship operation.\n  5. wait a bit for node to process sponsor operation from app.\n  6. check GET /sponsorships/{appId} to see if it really got sponsored.\n  7. proceed with posting the verification to the node under the appId.\n   */\n  const sp = await getSponsorship(appUserId, api);\n  if (sp && sp.appHasAuthorized && sp.spendRequested) {\n    console.log(\n      'the appUserId is used by another user to get sponsored before.',\n    );\n    Alert.alert(\n      i18next.t('apps.alert.title.linkingFailed'),\n      i18next.t('apps.alert.text.duplicateAppUserId', { appUserId }),\n    );\n    return;\n  }\n  const appInfo = find(propEq('id', appId))(apps) as AppInfo;\n  setSponsoringApp(appInfo);\n  console.log(`Sending spend sponsorship op...`);\n  const op = await api.spendSponsorship(appId, appUserId);\n\n  // TODO wait for op to be applied before starting polling sponsorship status?\n\n  // wait for app to complete the sponsorship\n  try {\n    await new Promise<void>((resolve, reject) => {\n      const startTime = Date.now();\n      const intervalId = setInterval(async () => {\n        const timeElapsed = Date.now() - startTime;\n        if (timeElapsed > sponsorTimeout) {\n          clearInterval(intervalId);\n          reject(new Error(`Timeout waiting for sponsorship`));\n        } else {\n          const sp = await getSponsorship(appUserId, api);\n          console.log(`Got sponsorRes: ${sp}`);\n          if (sp && sp.appHasAuthorized && sp.spendRequested) {\n            console.log(`Sponsorship complete!`);\n            clearInterval(intervalId);\n            resolve();\n          }\n        }\n      }, sponsorPollInterval);\n    });\n    // sponsoring complete\n    store.dispatch(setIsSponsoredv6(true));\n    setSponsoringApp(undefined);\n    onSuccess();\n  } catch (err) {\n    const msg = err instanceof Error ? err.message : err;\n    console.log(`Error getting sponsored: ${msg}`);\n    Alert.alert(i18next.t('apps.alert.title.linkingFailed'), `${msg}`, [\n      {\n        text: i18next.t('common.alert.dismiss'),\n        style: 'cancel',\n        onPress: () => null,\n      },\n    ]);\n  }\n};\n"]},"metadata":{},"sourceType":"module"}