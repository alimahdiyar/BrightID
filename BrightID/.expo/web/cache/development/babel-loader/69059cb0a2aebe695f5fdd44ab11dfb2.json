{"ast":null,"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getInvites = exports.getInviteGroup = exports.encryptAesKey = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _cryptoJs = _interopRequireDefault(require(\"crypto-js\"));\n\nvar _ramda = require(\"ramda\");\n\nvar _tweetnacl = _interopRequireDefault(require(\"tweetnacl\"));\n\nvar _ed2curve = require(\"ed2curve\");\n\nvar _store = _interopRequireDefault(require(\"../store\"));\n\nvar _encoding = require(\"./encoding\");\n\nvar _connectionsSlice = require(\"../reducer/connectionsSlice\");\n\nvar _filesystem = require(\"./filesystem\");\n\nvar _constants = require(\"./constants\");\n\nvar getInviteGroup = function _callee(inviteInfo, api) {\n  var _store$getState, secretKey, groups, existingGroup, conn, _await$api$getProfile, signingKeys, pub, msg, nonce, decryptedMessage, groupAesKey, group, res, data, infoString, info, groupObj, filename;\n\n  return _regenerator.default.async(function _callee$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          _context.prev = 0;\n          console.log('getting invite group info', inviteInfo);\n          _store$getState = _store.default.getState(), secretKey = _store$getState.keypair.secretKey, groups = _store$getState.groups.groups;\n          existingGroup = groups.find(function (g) {\n            return g.id === inviteInfo.group;\n          });\n\n          if (!(existingGroup && existingGroup.name && existingGroup.aesKey && existingGroup.aesKey !== '')) {\n            _context.next = 6;\n            break;\n          }\n\n          return _context.abrupt(\"return\", existingGroup);\n\n        case 6:\n          if (inviteInfo.data) {\n            _context.next = 8;\n            break;\n          }\n\n          return _context.abrupt(\"return\", undefined);\n\n        case 8:\n          conn = (0, _connectionsSlice.selectConnectionById)(_store.default.getState(), inviteInfo.inviter);\n          _context.next = 11;\n          return _regenerator.default.awrap(api.getProfile(conn.id));\n\n        case 11:\n          _await$api$getProfile = _context.sent;\n          signingKeys = _await$api$getProfile.signingKeys;\n          pub = (0, _ed2curve.convertPublicKey)((0, _encoding.b64ToUint8Array)(signingKeys[0]));\n          msg = (0, _encoding.b64ToUint8Array)(inviteInfo.data.split('_')[0]);\n          nonce = (0, _encoding.b64ToUint8Array)(inviteInfo.data.split('_')[1]);\n          decryptedMessage = _tweetnacl.default.box.open(msg, nonce, pub, (0, _ed2curve.convertSecretKey)(secretKey));\n\n          if (decryptedMessage) {\n            _context.next = 19;\n            break;\n          }\n\n          return _context.abrupt(\"return\", undefined);\n\n        case 19:\n          groupAesKey = (0, _encoding.uInt8ArrayToB64)(decryptedMessage);\n\n          if (groupAesKey) {\n            _context.next = 22;\n            break;\n          }\n\n          return _context.abrupt(\"return\", undefined);\n\n        case 22:\n          _context.next = 24;\n          return _regenerator.default.awrap(api.getGroup(inviteInfo.group));\n\n        case 24:\n          group = _context.sent;\n          _context.next = 27;\n          return _regenerator.default.awrap(fetch(group.url));\n\n        case 27:\n          res = _context.sent;\n          _context.next = 30;\n          return _regenerator.default.awrap(res.text());\n\n        case 30:\n          data = _context.sent;\n\n          if (data) {\n            _context.next = 33;\n            break;\n          }\n\n          return _context.abrupt(\"return\", undefined);\n\n        case 33:\n          infoString = _cryptoJs.default.AES.decrypt(data, groupAesKey).toString(_cryptoJs.default.enc.Utf8);\n          info = JSON.parse(infoString);\n          groupObj = (0, _extends2.default)({}, info, group);\n          filename = '';\n\n          if (!groupObj.photo) {\n            _context.next = 41;\n            break;\n          }\n\n          _context.next = 40;\n          return _regenerator.default.awrap((0, _filesystem.saveImage)({\n            imageName: groupObj.id,\n            base64Image: groupObj.photo\n          }));\n\n        case 40:\n          filename = _context.sent;\n\n        case 41:\n          groupObj.photo = {\n            filename: filename\n          };\n          groupObj.aesKey = groupAesKey;\n          return _context.abrupt(\"return\", groupObj);\n\n        case 46:\n          _context.prev = 46;\n          _context.t0 = _context[\"catch\"](0);\n          console.log(\"error in getting invite info \" + _context.t0.message);\n          return _context.abrupt(\"return\", undefined);\n\n        case 50:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, null, null, [[0, 46]], Promise);\n};\n\nexports.getInviteGroup = getInviteGroup;\n\nvar getInvites = function _callee3(api) {\n  var _store$getState2, id, _store$getState2$grou, oldInvites, inviteInfos, invites;\n\n  return _regenerator.default.async(function _callee3$(_context3) {\n    while (1) {\n      switch (_context3.prev = _context3.next) {\n        case 0:\n          _context3.prev = 0;\n          _store$getState2 = _store.default.getState(), id = _store$getState2.user.id, _store$getState2$grou = _store$getState2.groups.invites, oldInvites = _store$getState2$grou === void 0 ? [] : _store$getState2$grou;\n          _context3.next = 4;\n          return _regenerator.default.awrap(api.getInvites(id));\n\n        case 4:\n          inviteInfos = _context3.sent;\n          _context3.next = 7;\n          return _regenerator.default.awrap(Promise.all(inviteInfos.map(function _callee2(inviteInfo) {\n            var oldInvite;\n            return _regenerator.default.async(function _callee2$(_context2) {\n              while (1) {\n                switch (_context2.prev = _context2.next) {\n                  case 0:\n                    oldInvite = oldInvites.find((0, _ramda.eqProps)('id', inviteInfo));\n\n                    if (!(oldInvite && (oldInvite.group.name || !oldInvite.data))) {\n                      _context2.next = 5;\n                      break;\n                    }\n\n                    return _context2.abrupt(\"return\", (0, _extends2.default)({}, inviteInfo, {\n                      group: oldInvite.group,\n                      state: oldInvite.state\n                    }));\n\n                  case 5:\n                    _context2.t0 = _extends2.default;\n                    _context2.t1 = {};\n                    _context2.t2 = inviteInfo;\n                    _context2.next = 10;\n                    return _regenerator.default.awrap(getInviteGroup(inviteInfo, api));\n\n                  case 10:\n                    _context2.t3 = _context2.sent;\n                    _context2.t4 = _constants.INVITE_ACTIVE;\n                    _context2.t5 = {\n                      group: _context2.t3,\n                      state: _context2.t4\n                    };\n                    return _context2.abrupt(\"return\", (0, _context2.t0)(_context2.t1, _context2.t2, _context2.t5));\n\n                  case 14:\n                  case \"end\":\n                    return _context2.stop();\n                }\n              }\n            }, null, null, null, Promise);\n          })));\n\n        case 7:\n          invites = _context3.sent;\n          return _context3.abrupt(\"return\", invites.filter(function (invite) {\n            return invite.group;\n          }));\n\n        case 11:\n          _context3.prev = 11;\n          _context3.t0 = _context3[\"catch\"](0);\n          console.log(\"error in getting invite info \" + _context3.t0.message);\n          return _context3.abrupt(\"return\", []);\n\n        case 15:\n        case \"end\":\n          return _context3.stop();\n      }\n    }\n  }, null, null, [[0, 11]], Promise);\n};\n\nexports.getInvites = getInvites;\n\nvar encryptAesKey = function _callee4(aesKey, signingKey) {\n  var secretKey, pub, msg, nonce;\n  return _regenerator.default.async(function _callee4$(_context4) {\n    while (1) {\n      switch (_context4.prev = _context4.next) {\n        case 0:\n          _context4.prev = 0;\n          secretKey = _store.default.getState().keypair.secretKey;\n          pub = (0, _ed2curve.convertPublicKey)((0, _encoding.b64ToUint8Array)(signingKey));\n          msg = (0, _encoding.b64ToUint8Array)(aesKey);\n          _context4.next = 6;\n          return _regenerator.default.awrap((0, _encoding.randomKey)(24));\n\n        case 6:\n          nonce = _context4.sent;\n          return _context4.abrupt(\"return\", (0, _encoding.uInt8ArrayToB64)(_tweetnacl.default.box(msg, (0, _encoding.b64ToUint8Array)(nonce), pub, (0, _ed2curve.convertSecretKey)(secretKey))) + \"_\" + nonce);\n\n        case 10:\n          _context4.prev = 10;\n          _context4.t0 = _context4[\"catch\"](0);\n          console.log(_context4.t0.message);\n          return _context4.abrupt(\"return\", '');\n\n        case 14:\n        case \"end\":\n          return _context4.stop();\n      }\n    }\n  }, null, null, [[0, 10]], Promise);\n};\n\nexports.encryptAesKey = encryptAesKey;","map":{"version":3,"names":["getInviteGroup","inviteInfo","api","console","log","store","getState","secretKey","keypair","groups","existingGroup","find","g","id","group","name","aesKey","data","undefined","conn","selectConnectionById","inviter","getProfile","signingKeys","pub","convertPublicKey","b64ToUint8Array","msg","split","nonce","decryptedMessage","nacl","box","open","convertSecretKey","groupAesKey","uInt8ArrayToB64","getGroup","fetch","url","res","text","infoString","CryptoJS","AES","decrypt","toString","enc","Utf8","info","JSON","parse","groupObj","filename","photo","saveImage","imageName","base64Image","message","getInvites","user","invites","oldInvites","inviteInfos","Promise","all","map","oldInvite","eqProps","state","INVITE_ACTIVE","filter","invite","encryptAesKey","signingKey","randomKey"],"sources":["/home/ali/Desktop/brightid/BrightID/BrightID/src/utils/invites.ts"],"sourcesContent":["import CryptoJS from 'crypto-js';\nimport { eqProps } from 'ramda';\nimport nacl from 'tweetnacl';\nimport { convertPublicKey, convertSecretKey } from 'ed2curve';\nimport store from '@/store';\nimport { b64ToUint8Array, randomKey, uInt8ArrayToB64 } from '@/utils/encoding';\nimport { selectConnectionById } from '@/reducer/connectionsSlice';\nimport { saveImage } from './filesystem';\nimport { INVITE_ACTIVE } from './constants';\nimport { NodeApi } from '@/api/brightId';\n\nexport const getInviteGroup = async (inviteInfo: InviteInfo, api: NodeApi) => {\n  try {\n    console.log('getting invite group info', inviteInfo);\n\n    const {\n      keypair: { secretKey },\n      groups: { groups },\n    } = store.getState();\n\n    const existingGroup = groups.find((g) => g.id === inviteInfo.group);\n    if (\n      existingGroup &&\n      existingGroup.name &&\n      existingGroup.aesKey &&\n      existingGroup.aesKey !== ''\n    ) {\n      return existingGroup;\n    }\n\n    if (!inviteInfo.data) {\n      return undefined;\n    }\n\n    const conn = selectConnectionById(store.getState(), inviteInfo.inviter);\n    const { signingKeys } = await api.getProfile(conn.id);\n    const pub = convertPublicKey(b64ToUint8Array(signingKeys[0]));\n    const msg = b64ToUint8Array(inviteInfo.data.split('_')[0]);\n    const nonce = b64ToUint8Array(inviteInfo.data.split('_')[1]);\n    const decryptedMessage = nacl.box.open(\n      msg,\n      nonce,\n      pub,\n      convertSecretKey(secretKey),\n    );\n    if (!decryptedMessage) {\n      // can happen if the user recovered his account after the invitation was created\n      return undefined;\n    }\n    const groupAesKey = uInt8ArrayToB64(decryptedMessage);\n    if (!groupAesKey) {\n      return undefined;\n    }\n\n    // const uuidKey = invite.url.split('/').pop();\n    const group = await api.getGroup(inviteInfo.group);\n    const res = await fetch(group.url);\n    const data = await res.text();\n    if (!data) {\n      return undefined;\n    }\n\n    const infoString = CryptoJS.AES.decrypt(data, groupAesKey).toString(\n      CryptoJS.enc.Utf8,\n    );\n    const info = JSON.parse(infoString);\n    const groupObj = { ...info, ...group };\n    let filename = '';\n    if (groupObj.photo) {\n      filename = await saveImage({\n        imageName: groupObj.id,\n        base64Image: groupObj.photo,\n      });\n    }\n    groupObj.photo = { filename };\n    groupObj.aesKey = groupAesKey;\n    return groupObj;\n  } catch (err) {\n    console.log(`error in getting invite info ${err.message}`);\n    return undefined;\n  }\n};\n\nexport const getInvites = async (api: NodeApi) => {\n  try {\n    const {\n      user: { id },\n      groups: { invites: oldInvites = [] },\n    } = store.getState();\n    const inviteInfos = await api.getInvites(id);\n    const invites: Array<Invite> = await Promise.all(\n      inviteInfos.map(async (inviteInfo) => {\n        const oldInvite = oldInvites.find(eqProps('id', inviteInfo));\n        if (oldInvite && (oldInvite.group.name || !oldInvite.data)) {\n          return {\n            ...inviteInfo,\n            group: oldInvite.group,\n            state: oldInvite.state,\n          };\n        } else {\n          return {\n            ...inviteInfo,\n            group: await getInviteGroup(inviteInfo, api),\n            state: INVITE_ACTIVE,\n          };\n        }\n      }),\n    );\n    // exclude invites where group could not be determined\n    return invites.filter((invite) => invite.group);\n  } catch (err) {\n    console.log(`error in getting invite info ${err.message}`);\n    return [];\n  }\n};\n\n/**\n *\n * @param {string} aesKey\n * @param {string} signingKey\n * @returns string\n */\n\nexport const encryptAesKey = async (aesKey: string, signingKey: string) => {\n  try {\n    const { secretKey } = store.getState().keypair;\n\n    const pub = convertPublicKey(b64ToUint8Array(signingKey));\n    const msg = b64ToUint8Array(aesKey);\n    const nonce = await randomKey(24);\n    return `${uInt8ArrayToB64(\n      nacl.box(msg, b64ToUint8Array(nonce), pub, convertSecretKey(secretKey)),\n    )}_${nonce}`;\n  } catch (err) {\n    console.log(err.message);\n    return '';\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}